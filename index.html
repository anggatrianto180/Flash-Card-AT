<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard App with Firebase</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the card flip animation */
        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
        }
        .card-back {
             transform: rotateY(180deg);
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
             transition: transform 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header id="main-header" class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-600">Flashcard Pro</h1>
            <p class="text-gray-500 mt-2">Data publik untuk semua pengguna.</p>
        </header>

        <!-- Main content area -->
        <main id="main-content">
            <!-- Category List View -->
            <div id="category-list-view">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Pilih Kategori Anda</h2>
                    <button id="show-add-category-modal-btn" class="bg-indigo-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-plus fa-lg"></i>
                    </button>
                </div>
                <div id="category-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Category cards will be injected here -->
                </div>
            </div>

            <!-- Deck List View -->
            <div id="deck-list-view" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <div>
                        <button id="back-to-categories-btn" class="text-sm text-indigo-600 hover:underline mb-2"><i class="fas fa-arrow-left mr-1"></i> Kembali ke Kategori</button>
                        <h2 id="category-title" class="text-2xl font-semibold"></h2>
                    </div>
                    <button id="show-add-deck-modal-btn" class="bg-indigo-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-plus fa-lg"></i>
                    </button>
                </div>
                <div id="deck-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Deck cards will be injected here -->
                </div>
            </div>

            <!-- Flashcard Review View -->
            <div id="card-review-view" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 id="deck-title" class="text-2xl font-semibold"></h2>
                        <button id="edit-deck-name-btn" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-pencil-alt"></i></button>
                        <button id="delete-deck-btn" class="text-gray-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <button id="back-to-decks-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                        <i class="fas fa-chevron-left mr-2"></i> Kembali ke Dek
                    </button>
                </div>
                
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-semibold text-lg mb-2">Tambah Kartu Baru</h3>
                    <div class="flex flex-col md:flex-row gap-2">
                        <input type="text" id="new-card-front" class="flex-grow p-2 border border-gray-300 rounded-lg" placeholder="Depan (Pertanyaan)...">
                        <input type="text" id="new-card-back" class="flex-grow p-2 border border-gray-300 rounded-lg" placeholder="Belakang (Jawaban)...">
                        <button id="add-card-btn" class="bg-green-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-green-700">Tambah Kartu</button>
                    </div>
                </div>
                
                <div id="start-session-container" class="text-center my-8">
                    <button id="start-session-btn" class="bg-green-500 text-white font-bold py-4 px-8 rounded-lg text-xl hover:bg-green-600 transition-transform transform hover:scale-105 shadow-lg">
                        Mulai Menghafal <i class="fas fa-rocket ml-2"></i>
                    </button>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-semibold text-lg mb-2">Daftar Kartu</h3>
                    <div id="card-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </main>

        <!-- Study Focus View -->
        <div id="study-focus-view" class="hidden">
            <div class="flex justify-end mb-4">
                <button id="exit-focus-mode-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                    <i class="fas fa-times mr-2"></i> Keluar Mode Fokus
                </button>
            </div>
            <div id="study-session-view">
                 <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" class="w-full p-3 pl-10 border rounded-lg" placeholder="Cari kartu...">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button id="shuffle-btn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-random mr-2"></i> Acak Kartu
                    </button>
                </div>

                <div id="card-progress-container" class="mb-4">
                    <p id="card-progress-text" class="text-center text-gray-600 mb-1"></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="card-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <div id="flashcard-container" class="perspective-1000 w-full h-80 mb-6">
                    <div id="flashcard-inner" class="card-inner relative w-full h-full">
                        <div id="card-front" class="card-face bg-white rounded-xl shadow-lg flex items-center justify-center p-6 text-center">
                            <p class="text-3xl font-medium"></p>
                        </div>
                        <div id="card-back" class="card-back card-face bg-indigo-500 text-white rounded-xl shadow-lg flex flex-col items-center justify-center p-6 text-center">
                            <p class="text-2xl mb-4"></p>
                            <button id="generate-example-btn" class="bg-white text-indigo-600 font-semibold px-4 py-2 rounded-lg hover:bg-gray-200">
                                <span id="gen-example-text">âœ¨ Buat Contoh Kalimat</span>
                                <div id="gen-example-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-indigo-600 ml-2"></div>
                            </button>
                            <div id="example-sentence-container" class="mt-4 text-left text-sm w-full bg-indigo-600 p-3 rounded-lg hidden"></div>
                        </div>
                    </div>
                </div>

                <div id="action-buttons" class="hidden grid grid-cols-3 gap-4">
                    <button data-status="again" class="status-btn bg-red-500 text-white py-4 rounded-lg font-semibold text-lg hover:bg-red-600">Lagi</button>
                    <button data-status="good" class="status-btn bg-blue-500 text-white py-4 rounded-lg font-semibold text-lg hover:bg-blue-600">Bisa</button>
                    <button data-status="easy" class="status-btn bg-green-500 text-white py-4 rounded-lg font-semibold text-lg hover:bg-green-600">Mudah</button>
                </div>
                
                <div id="completion-message" class="hidden text-center bg-green-100 text-green-800 p-6 rounded-xl">
                    <h3 class="text-2xl font-semibold">ðŸŽ‰ Selamat!</h3>
                    <p class="mt-2">Anda telah menyelesaikan semua kartu di dek ini.</p>
                    <button id="restart-deck-btn" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Ulangi Dek</button>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="add-category-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md transform scale-95">
                <h3 class="text-xl font-semibold mb-4">Buat Kategori Baru</h3>
                <div>
                    <label for="add-category-name-input" class="block text-sm font-medium text-gray-700">Nama Kategori</label>
                    <input type="text" id="add-category-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-add-category-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Batal</button>
                    <button id="save-add-category-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Simpan</button>
                </div>
            </div>
        </div>

        <div id="add-deck-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md transform scale-95">
                <h3 class="text-xl font-semibold mb-4">Buat Dek Baru</h3>
                <div>
                    <label for="add-deck-name-input" class="block text-sm font-medium text-gray-700">Nama Dek</label>
                    <input type="text" id="add-deck-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-add-deck-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Batal</button>
                    <button id="save-add-deck-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Simpan</button>
                </div>
            </div>
        </div>

        <div id="edit-card-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md transform scale-95">
                <h3 class="text-xl font-semibold mb-4">Edit Kartu</h3>
                <div class="space-y-4">
                    <div>
                        <label for="edit-card-front" class="block text-sm font-medium text-gray-700">Depan</label>
                        <input type="text" id="edit-card-front" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    </div>
                    <div>
                        <label for="edit-card-back" class="block text-sm font-medium text-gray-700">Belakang</label>
                        <input type="text" id="edit-card-back" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-edit-card-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Batal</button>
                    <button id="save-edit-card-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Simpan</button>
                </div>
            </div>
        </div>

        <div id="edit-deck-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md transform scale-95">
                <h3 class="text-xl font-semibold mb-4">Edit Nama Dek</h3>
                <div>
                    <label for="edit-deck-name-input" class="block text-sm font-medium text-gray-700">Nama Dek</label>
                    <input type="text" id="edit-deck-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-edit-deck-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Batal</button>
                    <button id="save-edit-deck-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Simpan</button>
                </div>
            </div>
        </div>
        
        <div id="confirmation-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md transform scale-95">
                <h3 class="text-xl font-semibold mb-4">Konfirmasi Hapus</h3>
                <p id="confirmation-message" class="text-gray-600"></p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-confirmation-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Batal</button>
                    <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Hapus</button>
                </div>
            </div>
        </div>

    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, arrayUnion, onSnapshot, query, deleteDoc, arrayRemove, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA-ZuRnUy3_3-vR4mkZKqI3QeaVEFw-qPo",
          authDomain: "flash-card-b4d35.firebaseapp.com",
          projectId: "flash-card-b4d35",
          storageBucket: "flash-card-b4d35.firebasestorage.app",
          messagingSenderId: "467080205468",
          appId: "1:467080205468:web:0aa9350657f3d503f00959"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State (Global within module) ---
        let allCategories = {};
        let currentCategoryName = '';
        let currentDeckName = '';
        let userIsAuthenticated = false;
        let unsubscribeDecksListener = null;

        // --- Firebase Data Handling Functions (defined globally in the module) ---
        async function addCategoryToFirestore(categoryName) {
            if (!userIsAuthenticated || !categoryName) return;
            try {
                const newCategoryRef = doc(collection(db, 'categories'), categoryName);
                await setDoc(newCategoryRef, { name: categoryName });
            } catch (error) { console.error("Error adding category: ", error); }
        }

        async function deleteCategoryFromFirestore(categoryName) {
            if (!userIsAuthenticated || !categoryName) return;
            try {
                const decksRef = collection(db, 'categories', categoryName, 'decks');
                const deckSnapshot = await getDocs(decksRef);
                const deletePromises = [];
                deckSnapshot.forEach(deckDoc => {
                    deletePromises.push(deleteDoc(deckDoc.ref));
                });
                await Promise.all(deletePromises);

                const categoryRef = doc(collection(db, 'categories'), categoryName);
                await deleteDoc(categoryRef);
            } catch (error) {
                console.error("Error deleting category and its decks: ", error);
            }
        }

        async function addDeckToFirestore(categoryName, deckName) {
            if (!userIsAuthenticated || !categoryName || !deckName) return;
            try {
                const newDeckRef = doc(collection(db, 'categories', categoryName, 'decks'), deckName);
                await setDoc(newDeckRef, { name: deckName, cards: [], lastStudied: null });
            } catch (error) { console.error("Error adding deck: ", error); }
        }

        async function deleteDeckFromFirestore(categoryName, deckName) {
            if (!userIsAuthenticated || !categoryName || !deckName) return;
            try {
                const deckRef = doc(collection(db, 'categories', categoryName, 'decks'), deckName);
                await deleteDoc(deckRef);
            } catch (error) { console.error("Error deleting deck: ", error); }
        }
        
        async function updateDeckNameInFirestore(categoryName, oldName, newName) {
            if (!userIsAuthenticated || !oldName || !newName || oldName === newName) return;
            if (allCategories[categoryName][newName]) {
                alert('Nama dek sudah ada di kategori ini.');
                return;
            }
            try {
                const oldDeckData = allCategories[categoryName][oldName];
                const newDeckRef = doc(collection(db, 'categories', categoryName, 'decks'), newName);
                await setDoc(newDeckRef, { ...oldDeckData, name: newName });
                
                const oldDeckRef = doc(collection(db, 'categories', categoryName, 'decks'), oldName);
                await deleteDoc(oldDeckRef);
            } catch (error) { console.error("Error updating deck name: ", error); }
        }

        async function deleteCardFromFirestore(categoryName, deckName, cardToDelete) {
            if (!userIsAuthenticated) return;
            try {
                const deckRef = doc(collection(db, 'categories', categoryName, 'decks'), deckName);
                await updateDoc(deckRef, { cards: arrayRemove(cardToDelete) });
            } catch(error) { console.error("Error deleting card: ", error); }
        }

        async function updateCardInFirestore(categoryName, deckName, oldCard, newCard) {
            if (!userIsAuthenticated) return;
            try {
                const deckRef = doc(collection(db, 'categories', categoryName, 'decks'), deckName);
                await updateDoc(deckRef, { cards: arrayRemove(oldCard) });
                await updateDoc(deckRef, { cards: arrayUnion(newCard) });
            } catch (error) { console.error("Error updating card: ", error); }
        }

        async function addCardToFirestore(categoryName, deckName, front, back) {
            if (!userIsAuthenticated || !categoryName || !deckName || !front || !back) return;
            try {
                const deckRef = doc(collection(db, 'categories', categoryName, 'decks'), deckName);
                await updateDoc(deckRef, {
                    cards: arrayUnion({ front, back, status: 'new' })
                });
            } catch (error) {
                console.error("Error adding card: ", error);
            }
        }
        
        async function updateCardStatusInFirestore(categoryName, deckName, cardIndex, newStatus) {
            if (!userIsAuthenticated) return;
            try {
                const deckData = allCategories[categoryName][deckName];
                const updatedCards = [...deckData.cards];
                if (updatedCards[cardIndex]) {
                    updatedCards[cardIndex].status = newStatus;
                    const deckRef = doc(collection(db, 'categories', categoryName, 'decks'), deckName);
                    await updateDoc(deckRef, { cards: updatedCards });
                }
            } catch (error) {
                console.error("Error updating card status:", error);
            }
        }

        async function updateDeckLastStudied(categoryName, deckName) {
            if (!userIsAuthenticated) return;
            try {
                const deckRef = doc(collection(db, 'categories', categoryName, 'decks'), deckName);
                await updateDoc(deckRef, { lastStudied: serverTimestamp() });
            } catch (error) {
                console.error("Error updating last studied time:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mainHeader = document.getElementById('main-header');
            const mainContent = document.getElementById('main-content');
            const categoryListView = document.getElementById('category-list-view');
            const deckListView = document.getElementById('deck-list-view');
            const cardReviewView = document.getElementById('card-review-view');
            const categoryListContainer = document.getElementById('category-list');
            const deckListContainer = document.getElementById('deck-list');
            const categoryTitle = document.getElementById('category-title');
            const deckTitle = document.getElementById('deck-title');
            const backToCategoriesBtn = document.getElementById('back-to-categories-btn');
            const backToDecksBtn = document.getElementById('back-to-decks-btn');
            const flashcardInner = document.getElementById('flashcard-inner');
            const cardFrontText = document.querySelector('#card-front p');
            const cardBackText = document.querySelector('#card-back p');
            const actionButtons = document.getElementById('action-buttons');
            const statusButtons = document.querySelectorAll('.status-btn');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const searchInput = document.getElementById('search-input');
            const progressText = document.getElementById('card-progress-text');
            const progressBar = document.getElementById('card-progress-bar');
            const completionMessage = document.getElementById('completion-message');
            const restartDeckBtn = document.getElementById('restart-deck-btn');
            const generateExampleBtn = document.getElementById('generate-example-btn');
            const genExampleText = document.getElementById('gen-example-text');
            const genExampleSpinner = document.getElementById('gen-example-spinner');
            const exampleSentenceContainer = document.getElementById('example-sentence-container');
            const newCardFrontInput = document.getElementById('new-card-front');
            const newCardBackInput = document.getElementById('new-card-back');
            const addCardBtn = document.getElementById('add-card-btn');
            const startSessionContainer = document.getElementById('start-session-container');
            const startSessionBtn = document.getElementById('start-session-btn');
            const studyFocusView = document.getElementById('study-focus-view');
            const studySessionView = document.getElementById('study-session-view');
            const exitFocusModeBtn = document.getElementById('exit-focus-mode-btn');
            const cardListContainer = document.getElementById('card-list');
            const editDeckNameBtn = document.getElementById('edit-deck-name-btn');
            const deleteDeckBtn = document.getElementById('delete-deck-btn');
            const showAddCategoryModalBtn = document.getElementById('show-add-category-modal-btn');
            const addCategoryModal = document.getElementById('add-category-modal');
            const addCategoryModalContent = document.querySelector('#add-category-modal .modal-content');
            const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');
            const saveAddCategoryBtn = document.getElementById('save-add-category-btn');
            const addCategoryNameInput = document.getElementById('add-category-name-input');
            const showAddDeckModalBtn = document.getElementById('show-add-deck-modal-btn');
            const addDeckModal = document.getElementById('add-deck-modal');
            const addDeckModalContent = document.querySelector('#add-deck-modal .modal-content');
            const cancelAddDeckBtn = document.getElementById('cancel-add-deck-btn');
            const saveAddDeckBtn = document.getElementById('save-add-deck-btn');
            const addDeckNameInput = document.getElementById('add-deck-name-input');
            const editCardModal = document.getElementById('edit-card-modal');
            const editCardModalContent = document.querySelector('#edit-card-modal .modal-content');
            const cancelEditCardBtn = document.getElementById('cancel-edit-card-btn');
            const saveEditCardBtn = document.getElementById('save-edit-card-btn');
            const editCardFrontInput = document.getElementById('edit-card-front');
            const editCardBackInput = document.getElementById('edit-card-back');
            const editDeckModal = document.getElementById('edit-deck-modal');
            const editDeckModalContent = document.querySelector('#edit-deck-modal .modal-content');
            const cancelEditDeckBtn = document.getElementById('cancel-edit-deck-btn');
            const saveEditDeckBtn = document.getElementById('save-edit-deck-btn');
            const editDeckNameInput = document.getElementById('edit-deck-name-input');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationModalContent = document.querySelector('#confirmation-modal .modal-content');
            const confirmationMessage = document.getElementById('confirmation-message');
            const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            // --- App State ---
            let currentCards = [];
            let originalCards = [];
            let currentCardIndex = 0;
            let cardBeingEdited = null;
            let confirmAction = null;

            // --- Gemini API Configuration ---
            const API_KEY = ""; // Leave empty
            const API_URL_GENERATE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            
            async function generateExampleSentence(front, back) {
                const prompt = `Berikan satu contoh kalimat singkat dalam bahasa Inggris menggunakan kata "${front}" (yang artinya "${back}"). Sertakan juga terjemahan kalimatnya dalam bahasa Indonesia di baris baru. Format: Kalimat Inggris\nTerjemahan Indonesia`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(API_URL_GENERATE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Error generating example sentence:", error);
                    return "Gagal membuat contoh kalimat.";
                }
            }

            // --- Real-time Listeners ---
            function listenToCategories() {
                if (!userIsAuthenticated) return;
                const categoriesCollectionRef = collection(db, 'categories');
                onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                    allCategories = {};
                    snapshot.forEach(doc => {
                        allCategories[doc.id] = {};
                    });
                    renderCategories();
                });
            }

            function listenToDecks(categoryName) {
                if (unsubscribeDecksListener) {
                    unsubscribeDecksListener();
                }
                const decksRef = collection(db, 'categories', categoryName, 'decks');
                unsubscribeDecksListener = onSnapshot(query(decksRef), (snapshot) => {
                    const decks = {};
                    snapshot.forEach(doc => {
                        decks[doc.id] = doc.data();
                    });
                    allCategories[categoryName] = decks;
                    
                    if (!deckListView.classList.contains('hidden')) {
                         renderDecks(categoryName);
                    }
                    
                    if (!cardReviewView.classList.contains('hidden') && allCategories[currentCategoryName]?.[currentDeckName]) {
                        const oldOriginalCards = originalCards;
                        originalCards = [...allCategories[currentCategoryName][currentDeckName].cards];
                        renderCardList(currentCategoryName, currentDeckName);

                        // FIX: Only update currentCards if the session is not active to prevent resets
                        if (studyFocusView.classList.contains('hidden')) {
                            searchCards(searchInput.value);
                        } else {
                            // If session is active, just update the base data without changing the current card
                            const currentSearch = searchInput.value.toLowerCase();
                            currentCards = originalCards.filter(card => 
                                card.front.toLowerCase().includes(currentSearch) ||
                                card.back.toLowerCase().includes(currentSearch)
                            );
                        }
                    }
                });
            }

            // --- RENDERING ---
            const renderCategories = () => {
                categoryListContainer.innerHTML = '';
                const sortedCategoryNames = Object.keys(allCategories).sort();
                if (sortedCategoryNames.length === 0) {
                    categoryListContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">Belum ada kategori. Klik tombol + untuk membuat.</p>`;
                }
                sortedCategoryNames.forEach(categoryName => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer relative';
                    categoryCard.dataset.categoryName = categoryName;
                    categoryCard.innerHTML = `
                        <div class="absolute top-2 right-2 flex gap-2">
                            <button data-category-name-edit="${categoryName}" class="edit-category-btn text-gray-400 hover:text-indigo-600"><i class="fas fa-pencil-alt"></i></button>
                            <button data-category-name-delete="${categoryName}" class="delete-category-btn text-gray-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <h3 class="text-xl font-semibold text-indigo-700 pointer-events-none">${categoryName}</h3>
                    `;
                    categoryListContainer.appendChild(categoryCard);
                });
            };

            const renderDecks = (categoryName) => {
                deckListContainer.innerHTML = '';
                const decks = allCategories[categoryName] || {};
                const sortedDeckNames = Object.keys(decks).sort();
                if (sortedDeckNames.length === 0) {
                    deckListContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">Belum ada dek di kategori ini.</p>`;
                }
                sortedDeckNames.forEach(deckName => {
                    const deckData = decks[deckName];
                    const cardCount = deckData.cards.length;
                    let lastStudiedHTML = '';
                    if (deckData.lastStudied) {
                        const date = deckData.lastStudied.toDate();
                        const formattedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                        lastStudiedHTML = `<p class="text-xs text-gray-400 mt-2">Terakhir dipelajari: ${formattedDate}</p>`;
                    }

                    const deckCard = document.createElement('div');
                    deckCard.className = 'bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer';
                    deckCard.dataset.deckName = deckName;
                    deckCard.innerHTML = `
                        <h3 class="text-xl font-semibold text-indigo-700 pointer-events-none">${deckName}</h3>
                        <p class="text-gray-500 mt-2 pointer-events-none">${cardCount} kartu</p>
                        ${lastStudiedHTML}
                    `;
                    deckListContainer.appendChild(deckCard);
                });
            };

            const renderCardList = (categoryName, deckName) => {
                cardListContainer.innerHTML = '';
                const cards = allCategories[categoryName]?.[deckName]?.cards || [];
                const statusColors = {
                    again: 'bg-red-400',
                    good: 'bg-blue-400',
                    easy: 'bg-green-400',
                    new: 'bg-gray-400'
                };
                if (cards.length === 0) {
                    cardListContainer.innerHTML = `<p class="text-gray-500 text-center">Belum ada kartu di dek ini.</p>`;
                }
                cards.forEach((card, index) => {
                    const cardItem = document.createElement('div');
                    cardItem.className = 'flex justify-between items-center p-2 border-b';
                    const statusColor = statusColors[card.status] || 'bg-gray-400';
                    cardItem.innerHTML = `
                        <div class="flex items-center gap-3">
                           <span class="w-3 h-3 rounded-full ${statusColor}"></span>
                           <span>${card.front}</span>
                        </div>
                        <div class="flex gap-2">
                            <button data-card-index="${index}" class="edit-card-btn text-gray-400 hover:text-indigo-600"><i class="fas fa-pencil-alt"></i></button>
                            <button data-card-index="${index}" class="delete-card-btn text-gray-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    cardListContainer.appendChild(cardItem);
                });
            };

            const renderCard = () => {
                updateProgress();
                flashcardInner.classList.remove('is-flipped');
                actionButtons.classList.add('hidden');
                completionMessage.classList.add('hidden');
                exampleSentenceContainer.classList.add('hidden');
                exampleSentenceContainer.innerHTML = '';
                if (currentCards.length === 0) {
                    cardFrontText.textContent = "Dek ini kosong. Tambahkan kartu baru di atas.";
                    cardBackText.textContent = "";
                    document.getElementById('flashcard-container').classList.remove('hidden');
                    return;
                }
                if (currentCardIndex >= currentCards.length) {
                    showCompletionMessage();
                    return;
                }
                const card = currentCards[currentCardIndex];
                cardFrontText.textContent = card.front;
                cardBackText.textContent = card.back;
            };
            
            const showCompletionMessage = () => {
                completionMessage.classList.remove('hidden');
                document.getElementById('flashcard-container').classList.add('hidden');
                progressText.textContent = `Selesai! ${originalCards.length} dari ${originalCards.length} kartu.`;
            }

            const updateProgress = () => {
                const total = originalCards.length;
                const current = Math.min(currentCardIndex + 1, total);
                if (total === 0) {
                    progressText.textContent = "Tidak ada kartu di dek ini.";
                    progressBar.style.width = '0%';
                    return;
                }
                document.getElementById('flashcard-container').classList.remove('hidden');
                if (currentCardIndex >= currentCards.length) {
                     progressText.textContent = `Selesai! ${total} dari ${total} kartu.`;
                     progressBar.style.width = `100%`;
                } else {
                    progressText.textContent = `Kartu ${current} dari ${total}`;
                    progressBar.style.width = `${(current / total) * 100}%`;
                }
            };

            // --- APP LOGIC & NAVIGATION ---
            const selectCategory = (categoryName) => {
                currentCategoryName = categoryName;
                categoryTitle.textContent = categoryName;
                listenToDecks(categoryName);
                categoryListView.classList.add('hidden');
                deckListView.classList.remove('hidden');
            };

            const selectDeck = (categoryName, deckName) => {
                currentCategoryName = categoryName;
                currentDeckName = deckName;
                originalCards = [...allCategories[categoryName][deckName].cards];
                currentCards = [...originalCards];
                currentCardIndex = 0;
                deckTitle.textContent = deckName;
                searchInput.value = '';
                
                renderCardList(categoryName, deckName);

                deckListView.classList.add('hidden');
                cardReviewView.classList.remove('hidden');
                
                studyFocusView.classList.add('hidden');
                startSessionContainer.classList.remove('hidden');
                completionMessage.classList.add('hidden');
            };
            
            const restartDeck = () => {
                currentCards = [...originalCards];
                currentCardIndex = 0;
                renderCard();
            }

            const flipCard = () => {
                if (currentCards.length > 0 && currentCardIndex < currentCards.length) {
                    flashcardInner.classList.toggle('is-flipped');
                    actionButtons.classList.toggle('hidden');
                }
            };
            
            const handleStatusUpdate = (status) => {
                const cardToUpdate = currentCards[currentCardIndex];
                const originalIndex = originalCards.findIndex(c => c.front === cardToUpdate.front && c.back === cardToUpdate.back);
                if (originalIndex !== -1) {
                    updateCardStatusInFirestore(currentCategoryName, currentDeckName, originalIndex, status);
                }
                
                // FIX: Use a timeout to prevent the next card's answer from flashing
                if (flashcardInner.classList.contains('is-flipped')) {
                    flashcardInner.classList.remove('is-flipped');
                    actionButtons.classList.add('hidden');
                    setTimeout(() => {
                        currentCardIndex++;
                        renderCard();
                    }, 300); // Half of the 0.6s transition
                } else {
                    currentCardIndex++;
                    renderCard();
                }
            };
            
            const shuffleCards = () => {
                for (let i = currentCards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentCards[i], currentCards[j]] = [currentCards[j], currentCards[i]];
                }
                currentCardIndex = 0;
                renderCard();
            };

            const searchCards = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                currentCards = originalCards.filter(card => 
                    card.front.toLowerCase().includes(lowerCaseQuery) ||
                    card.back.toLowerCase().includes(lowerCaseQuery)
                );
                currentCardIndex = 0;
                if (studyFocusView.style.display !== 'none') {
                    renderCard();
                }
            };

            // --- Modal Logic ---
            const showModal = (modal, content) => {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                }, 10);
            };

            const hideModal = (modal, content) => {
                modal.classList.add('opacity-0');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 250);
            };

            const showConfirmationModal = (message, onConfirm) => {
                confirmationMessage.textContent = message;
                confirmAction = onConfirm;
                showModal(confirmationModal, confirmationModalContent);
            };

            // --- EVENT LISTENERS ---
            showAddCategoryModalBtn.addEventListener('click', () => {
                addCategoryNameInput.value = '';
                showModal(addCategoryModal, addCategoryModalContent);
            });

            showAddDeckModalBtn.addEventListener('click', () => {
                addDeckNameInput.value = '';
                showModal(addDeckModal, addDeckModalContent);
            });

            addCardBtn.addEventListener('click', () => {
                const front = newCardFrontInput.value.trim();
                const back = newCardBackInput.value.trim();
                if (front && back && currentDeckName) {
                    addCardToFirestore(currentCategoryName, currentDeckName, front, back);
                    newCardFrontInput.value = '';
                    newCardBackInput.value = '';
                }
            });

            backToCategoriesBtn.addEventListener('click', () => {
                if (unsubscribeDecksListener) unsubscribeDecksListener();
                deckListView.classList.add('hidden');
                categoryListView.classList.remove('hidden');
                currentCategoryName = '';
            });

            backToDecksBtn.addEventListener('click', () => {
                cardReviewView.classList.add('hidden');
                deckListView.classList.remove('hidden');
                currentDeckName = ''; 
            });
            
            categoryListContainer.addEventListener('click', (e) => {
                const categoryCard = e.target.closest('[data-category-name]');
                const deleteBtn = e.target.closest('.delete-category-btn');

                if (deleteBtn) {
                    e.stopPropagation(); // Prevent card click
                    const categoryName = deleteBtn.dataset.categoryNameDelete;
                    showConfirmationModal(`Apakah Anda yakin ingin menghapus kategori "${categoryName}" beserta semua dek di dalamnya?`, () => {
                        deleteCategoryFromFirestore(categoryName);
                    });
                    return;
                }

                if (categoryCard) {
                    selectCategory(categoryCard.dataset.categoryName);
                }
            });

            deckListContainer.addEventListener('click', (e) => {
                const deckCard = e.target.closest('[data-deck-name]');
                if (deckCard) {
                    selectDeck(currentCategoryName, deckCard.dataset.deckName);
                }
            });

            startSessionBtn.addEventListener('click', () => {
                updateDeckLastStudied(currentCategoryName, currentDeckName);
                mainContent.classList.add('hidden');
                mainHeader.classList.add('hidden');
                studyFocusView.classList.remove('hidden');
                renderCard();
            });
            
            exitFocusModeBtn.addEventListener('click', () => {
                studyFocusView.classList.add('hidden');
                mainContent.classList.remove('hidden');
                mainHeader.classList.remove('hidden');
                selectDeck(currentCategoryName, currentDeckName);
            });

            flashcardInner.addEventListener('click', (e) => {
                if (!e.target.closest('button')) flipCard();
            });

            statusButtons.forEach(button => {
                button.addEventListener('click', () => handleStatusUpdate(button.dataset.status));
            });

            shuffleBtn.addEventListener('click', shuffleCards);
            restartDeckBtn.addEventListener('click', restartDeck);
            searchInput.addEventListener('input', (e) => searchCards(e.target.value));

            generateExampleBtn.addEventListener('click', async () => {
                if (currentCards.length === 0) return;
                const card = currentCards[currentCardIndex];
                genExampleSpinner.classList.remove('hidden');
                genExampleText.textContent = 'Membuat...';
                generateExampleBtn.disabled = true;
                const example = await generateExampleSentence(card.front, card.back);
                exampleSentenceContainer.innerHTML = example.replace(/\n/g, '<br>');
                exampleSentenceContainer.classList.remove('hidden');
                genExampleSpinner.classList.add('hidden');
                genExampleText.textContent = 'âœ¨ Buat Contoh Kalimat';
                generateExampleBtn.disabled = false;
            });

            deleteDeckBtn.addEventListener('click', () => {
                showConfirmationModal(`Apakah Anda yakin ingin menghapus dek "${currentDeckName}"?`, () => {
                    deleteDeckFromFirestore(currentCategoryName, currentDeckName);
                });
            });

            editDeckNameBtn.addEventListener('click', () => {
                editDeckNameInput.value = currentDeckName;
                showModal(editDeckModal, editDeckModalContent);
            });

            cardListContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-card-btn');
                const deleteBtn = e.target.closest('.delete-card-btn');

                if (editBtn) {
                    const cardIndex = parseInt(editBtn.dataset.cardIndex, 10);
                    cardBeingEdited = allCategories[currentCategoryName][currentDeckName].cards[cardIndex];
                    editCardFrontInput.value = cardBeingEdited.front;
                    editCardBackInput.value = cardBeingEdited.back;
                    showModal(editCardModal, editCardModalContent);
                }

                if (deleteBtn) {
                    const cardIndex = parseInt(deleteBtn.dataset.cardIndex, 10);
                    const card = allCategories[currentCategoryName][currentDeckName].cards[cardIndex];
                    showConfirmationModal(`Hapus kartu "${card.front}"?`, () => {
                        deleteCardFromFirestore(currentCategoryName, currentDeckName, card);
                    });
                }
            });

            saveAddCategoryBtn.addEventListener('click', () => {
                const newName = addCategoryNameInput.value.trim();
                if (newName && !allCategories[newName]) {
                    addCategoryToFirestore(newName);
                    hideModal(addCategoryModal, addCategoryModalContent);
                } else if (allCategories[newName]) {
                    alert('Nama kategori sudah ada.');
                }
            });
            cancelAddCategoryBtn.addEventListener('click', () => hideModal(addCategoryModal, addCategoryModalContent));

            saveAddDeckBtn.addEventListener('click', () => {
                const newName = addDeckNameInput.value.trim();
                if (newName && (!allCategories[currentCategoryName] || !allCategories[currentCategoryName][newName])) {
                    addDeckToFirestore(currentCategoryName, newName);
                    hideModal(addDeckModal, addDeckModalContent);
                } else if (allCategories[currentCategoryName] && allCategories[currentCategoryName][newName]) {
                    alert('Nama dek sudah ada.');
                }
            });
            cancelAddDeckBtn.addEventListener('click', () => hideModal(addDeckModal, addDeckModalContent));
            
            saveEditCardBtn.addEventListener('click', () => {
                const newFront = editCardFrontInput.value.trim();
                const newBack = editCardBackInput.value.trim();
                if (newFront && newBack && cardBeingEdited) {
                    const newCard = { front: newFront, back: newBack, status: cardBeingEdited.status || 'new' };
                    updateCardInFirestore(currentCategoryName, currentDeckName, cardBeingEdited, newCard);
                    hideModal(editCardModal, editCardModalContent);
                }
            });
            cancelEditCardBtn.addEventListener('click', () => hideModal(editCardModal, editCardModalContent));

            saveEditDeckBtn.addEventListener('click', () => {
                const newName = editDeckNameInput.value.trim();
                if (newName) {
                    updateDeckNameInFirestore(currentCategoryName, currentDeckName, newName);
                    hideModal(editDeckModal, editDeckModalContent);
                }
            });
            cancelEditDeckBtn.addEventListener('click', () => hideModal(editDeckModal, editDeckModalContent));

            confirmDeleteBtn.addEventListener('click', () => {
                if (confirmAction) {
                    confirmAction();
                }
                hideModal(confirmationModal, confirmationModalContent);
            });
            cancelConfirmationBtn.addEventListener('click', () => hideModal(confirmationModal, confirmationModalContent));
            
            // --- INITIAL AUTHENTICATION & DATA LOAD ---
            setPersistence(auth, browserLocalPersistence)
                .then(() => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userIsAuthenticated = true;
                            listenToCategories();
                        } else {
                            signInAnonymously(auth).catch((error) => {
                                console.error("Anonymous sign-in failed:", error);
                            });
                        }
                    });
                })
                .catch((error) => {
                    console.error("Error setting persistence:", error);
                });
        });
    </script>
</body>
</html>
